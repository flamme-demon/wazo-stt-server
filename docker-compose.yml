services:
  wazo-stt:
    build:
      context: .
      dockerfile: Dockerfile
    image: wazo-stt-server:latest
    container_name: wazo-stt-server
    ports:
      - "8000:8000"
    volumes:
      - models:/models
    environment:
      - MODEL_PATH=/models/parakeet
      - HOST=0.0.0.0
      - PORT=8000
      - RUST_LOG=info
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  model-downloader:
    image: alpine:latest
    container_name: model-downloader
    volumes:
      - models:/models
    entrypoint: ["/bin/sh", "-c"]
    command:
      - |
        set -e
        apk add --no-cache curl

        MODEL_DIR=/models/parakeet
        MODEL_URL="https://huggingface.co/smcleod/parakeet-tdt-0.6b-v2-int8/resolve/main"

        echo "=== Parakeet Model Downloader ==="
        echo "Model directory: $$MODEL_DIR"

        mkdir -p "$$MODEL_DIR"

        download_file() {
          url="$$1"
          output="$$2"
          if [ -f "$$output" ]; then
            echo "File already exists: $$output"
            return 0
          fi
          echo "Downloading: $$output"
          curl -L --progress-bar -o "$$output" "$$url"
        }

        echo ""
        echo "Downloading Parakeet TDT 0.6B v2 (int8 quantized)..."
        echo ""

        download_file "$${MODEL_URL}/encoder-model.int8.onnx" "$${MODEL_DIR}/encoder.onnx"
        download_file "$${MODEL_URL}/encoder-model.int8.onnx.data" "$${MODEL_DIR}/encoder.onnx.data" || true
        download_file "$${MODEL_URL}/decoder_joint-model.int8.onnx" "$${MODEL_DIR}/decoder.onnx"
        download_file "$${MODEL_URL}/nemo128.onnx" "$${MODEL_DIR}/preprocessor.onnx"

        # Download tokens.txt
        if [ ! -f "$${MODEL_DIR}/tokens.txt" ]; then
          echo "Downloading tokens.txt..."
          curl -L -o "$${MODEL_DIR}/tokens.txt" \
            "https://huggingface.co/csukuangfj/sherpa-onnx-nemo-parakeet-tdt-0.6b-v2-int8/resolve/main/tokens.txt" || true
        fi

        echo ""
        echo "=== Download Complete ==="
        echo "Model files in $$MODEL_DIR:"
        ls -lh "$$MODEL_DIR"
        echo ""
    profiles:
      - setup

volumes:
  models:
    name: wazo-stt-models
